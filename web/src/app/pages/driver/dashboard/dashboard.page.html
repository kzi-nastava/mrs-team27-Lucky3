<div class="min-h-screen bg-black text-white p-4 lg:p-6">
  <!-- Toast Notification -->
  <app-toast
    [show]="showToast"
    [message]="toastMessage"
    [type]="toastType"
    (close)="onToastClose()">
  </app-toast>

  <div class="max-w-6xl mx-auto space-y-6">
    
    <!-- Header Card -->
    <div class="bg-[#1C1C1E] p-6 rounded-xl border border-gray-800">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div>
          <h1 class="text-3xl font-bold mb-2">Welcome back, {{ driverName }}!</h1>
          <p class="text-gray-400">
            {{ isOnline ? 'You are online and available for rides' : 'You are currently offline' }}
          </p>
        </div>
        <div class="flex items-center gap-4">
          <app-toggle-switch 
            [checked]="isOnline" 
            [label]="isOnline ? 'Online' : 'Offline'"
            [disabled]="isStatusLoading"
            (checkedChange)="onStatusChange($event)">
          </app-toggle-switch>
          <div class="w-3 h-3 rounded-full transition-colors duration-300"
               [class.bg-green-500]="isOnline"
               [class.animate-pulse]="isOnline"
               [class.bg-gray-500]="!isOnline">
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Grid - only show when online -->
    <div *ngIf="isOnline || isInactiveRequested" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <app-stat-card 
        title="Today's Earnings" 
        [value]="(stats.earnings | number:'1.2-2') + ' RSD'"
        iconBgColor="bg-yellow-500/20"
        iconColor="text-yellow-500">
        <svg icon xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#EAB308" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      </app-stat-card>

      <app-stat-card 
        title="Rides Completed" 
        [value]="stats.ridesCompleted"
        iconBgColor="bg-gray-700/50"
        iconColor="text-white">
        <svg icon xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      </app-stat-card>

      <app-stat-card 
        title="Rating" 
        [value]="stats.rating"
        iconBgColor="bg-yellow-500/20"
        iconColor="text-yellow-500">
        <svg icon xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#EAB308" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      </app-stat-card>

      <app-stat-card 
        title="Online Hours" 
        [value]="stats.onlineHours"
        iconBgColor="bg-gray-700/50"
        iconColor="text-white">
        <svg icon xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      </app-stat-card>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left Column: Active Ride / Map -->
      <div class="space-y-6">
        <!-- Next Ride -->
        <div class="bg-[#1C1C1E] p-4 rounded-xl border border-gray-800">
          <div class="flex items-center justify-between mb-4">
            <ng-container *ngIf="nextRide && (isOnline || isInactiveRequested); else defaultHeader">
              <div *ngIf="nextRide.status === 'IN_PROGRESS'" class="bg-green-500/20 border border-green-500/30 text-green-400 px-3 py-1 rounded-lg text-sm font-bold uppercase tracking-wider">Active ride</div>
              <div *ngIf="nextRide.status !== 'IN_PROGRESS'" class="bg-blue-600/20 border border-blue-600/30 text-blue-400 px-3 py-1 rounded-lg text-sm font-bold uppercase tracking-wider">Pending</div>
            </ng-container>
            <ng-template #defaultHeader>
              <h2 class="text-lg font-bold">Next Ride</h2>
            </ng-template>
            <span *ngIf="nextRide && (isOnline || isInactiveRequested)" class="text-xs text-gray-400">Tap to view details</span>
          </div>

          <ng-container *ngIf="nextRide && (isOnline || isInactiveRequested); else noNextRide">
            <app-ride-request-card
              class="block"
              [link]="['/driver/ride', nextRide.id]"
              [showAction]="false"
              [type]="nextRide.type"
              [price]="nextRide.price"
              [distance]="nextRide.distance"
              [time]="nextRide.time"
              [pickup]="nextRide.pickup"
              [dropoff]="nextRide.dropoff"
            ></app-ride-request-card>
          </ng-container>

          <ng-template #noNextRide>
            <div class="bg-gray-900/40 rounded-xl border border-gray-800 p-8 text-center">
              <div class="mx-auto w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center mb-3">
                <span class="text-gray-300 text-xl">!</span>
              </div>
              <ng-container *ngIf="!isOnline && !isInactiveRequested; else noRidesOnline">
                <div class="text-white font-semibold">You are offline</div>
                <div class="text-gray-400 text-sm mt-1">Go online to receive ride requests.</div>
              </ng-container>
              <ng-template #noRidesOnline>
                <div class="text-white font-semibold">No accepted rides yet</div>
                <div class="text-gray-400 text-sm mt-1">You'll see your next scheduled ride here.</div>
              </ng-template>
            </div>
          </ng-template>
        </div>

        <!-- Live Map (driver location) -->
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold">Map</h2>
            <span class="text-xs text-gray-400" *ngIf="!driverLocation && isOnline">Location unavailable</span>
            <span class="text-xs text-gray-400" *ngIf="!isOnline && !isInactiveRequested">You are offline</span>
          </div>
          <div class="h-[360px] rounded-xl overflow-hidden border border-gray-800 relative">
            <app-active-ride-map 
              class="absolute inset-0"
              [ride]="rideMapData" 
              [routePolyline]="routePolyline" 
              [approachRoute]="approachRoute"
              [remainingRoute]="remainingRoute"
              [driverLocation]="driverLocation"
              [completedStopIndexes]="completedStopIndexes"
              [isRideInProgress]="isNextRideInProgress">
            </app-active-ride-map>
            <!-- Offline overlay -->
            <div *ngIf="!isOnline && !isInactiveRequested" 
                 class="absolute inset-0 bg-black/60 flex items-center justify-center z-10">
              <span class="text-gray-400 text-sm">Go online to see the map</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Available Rides -->
      <div class="space-y-4">
        <div class="bg-[#1C1C1E] p-4 rounded-xl border border-gray-800">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold">Available Rides ({{ isOnline || isInactiveRequested ? futureRides.length : 0 }})</h2>
            <button
              *ngIf="futureRides.length > 0 && (isOnline || isInactiveRequested)"
              type="button"
              (click)="toggleAllFutureRides()"
              class="text-sm font-semibold text-yellow-500 hover:text-yellow-400 transition-colors"
            >
              {{ showAllFutureRides ? 'Hide all' : 'Show all future rides' }}
            </button>
          </div>

          <div class="space-y-4">
            <!-- Offline message -->
            <ng-container *ngIf="!isOnline && !isInactiveRequested; else ridesContent">
              <div class="text-sm text-gray-400">Go online to see available rides.</div>
            </ng-container>

            <ng-template #ridesContent>
              <ng-container *ngIf="dashboardRides.length > 0; else noMoreRides">
                <app-ride-request-card
                  *ngFor="let ride of dashboardRides"
                  [link]="['/driver/ride', ride.id]"
                  [type]="ride.type"
                  [price]="ride.price"
                  [distance]="ride.distance"
                  [time]="ride.time"
                  [pickup]="ride.pickup"
                  [dropoff]="ride.dropoff"
                  actionLabel="Cancel Ride"
                  actionVariant="danger"
                  (action)="cancelRide(ride.id)"
                ></app-ride-request-card>
              </ng-container>
            </ng-template>

            <ng-template #noMoreRides>
              <div class="text-sm text-gray-400">No additional upcoming rides.</div>
            </ng-template>
          </div>

          <div *ngIf="showAllFutureRides && (isOnline || isInactiveRequested)" class="mt-4 pt-4 border-t border-gray-800">
            <h3 class="text-sm font-semibold text-gray-200 mb-3">All future rides</h3>
            <div class="space-y-4">
              <app-ride-request-card
                *ngFor="let ride of futureRides"
                [link]="['/driver/ride', ride.id]"
                [type]="ride.type"
                [price]="ride.price"
                [distance]="ride.distance"
                [time]="ride.time"
                [pickup]="ride.pickup"
                [dropoff]="ride.dropoff"
                actionLabel="Cancel Ride"
                actionVariant="danger"
                (action)="cancelRide(ride.id)"
              ></app-ride-request-card>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
