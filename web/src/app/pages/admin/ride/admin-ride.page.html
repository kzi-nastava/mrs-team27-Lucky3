<div class="min-h-screen bg-black text-white p-4 lg:p-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <button (click)="goBack()" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" x2="5" y1="12" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        Back to Dashboard
      </button>
      <div class="flex items-center gap-3" *ngIf="ride">
        <h1 class="text-xl font-bold">Ride #{{ ride.id }}</h1>
        <span 
          class="px-3 py-1 rounded-full text-sm font-semibold border"
          [ngClass]="statusClass"
        >
          {{ statusLabel }}
        </span>
        <span 
          *ngIf="panicActivated"
          class="px-3 py-1 rounded-full text-sm font-semibold border bg-red-500/20 border-red-500/50 text-red-400 animate-pulse cursor-pointer"
          (click)="openPanicModal()"
        >
          üö® PANIC
        </span>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="flex flex-col items-center justify-center py-16">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 mb-4"></div>
      <p class="text-gray-400">Loading ride details...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMessage && !isLoading" class="flex flex-col items-center justify-center py-16">
      <div class="text-red-500 text-xl mb-2">‚ö†Ô∏è</div>
      <p class="text-red-400">{{ errorMessage }}</p>
      <button (click)="goBack()" class="mt-4 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors">
        Go Back
      </button>
    </div>

    <!-- Content -->
    <div *ngIf="ride && !isLoading" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column: Map -->
      <div class="lg:col-span-2">
        <div class="bg-[#1C1C1E] rounded-2xl border border-gray-800 overflow-hidden h-[500px] relative">
          <app-active-ride-map 
            class="absolute inset-0"
            [ride]="rideMapData"
            [routePolyline]="routePolyline"
            [approachRoute]="approachRoute"
            [remainingRoute]="remainingRoute"
            [driverLocation]="driverLocation"
            [completedStopIndexes]="completedStopIndexes"
            [isRideInProgress]="isRideInProgress"
            [panicActivated]="panicActivated">
          </app-active-ride-map>
        </div>
      </div>

      <!-- Right Column: Details -->
      <div class="space-y-6">
        <!-- Ride Info Card -->
        <div class="bg-[#1C1C1E] rounded-2xl border border-gray-800 p-5">
          <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>
            Ride Summary
          </h2>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-black/40 rounded-lg p-3 border border-gray-800">
              <div class="text-xs text-gray-400 mb-1">{{ isRideInProgress ? 'Current Cost' : 'Est. Cost' }}</div>
              <div class="text-lg font-bold text-yellow-500">{{ formatCost() }} RSD</div>
            </div>
            <div class="bg-black/40 rounded-lg p-3 border border-gray-800">
              <div class="text-xs text-gray-400 mb-1">Distance</div>
              <div class="text-lg font-bold text-white">{{ formatDistance() }} km</div>
            </div>
            <div class="bg-black/40 rounded-lg p-3 border border-gray-800">
              <div class="text-xs text-gray-400 mb-1">Est. Time</div>
              <div class="text-lg font-bold text-white">{{ formatTime() }}</div>
            </div>
            <div class="bg-black/40 rounded-lg p-3 border border-gray-800">
              <div class="text-xs text-gray-400 mb-1">Vehicle Type</div>
              <div class="text-lg font-bold text-white">{{ getVehicleType() }}</div>
            </div>
          </div>
        </div>

        <!-- Driver Card -->
        <div class="bg-[#1C1C1E] rounded-2xl border border-gray-800 p-5">
          <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            Driver
          </h2>
          
          <div class="flex items-center gap-4">
            <img 
              *ngIf="ride.driver?.id"
              [src]="getDriverImageUrl()" 
              alt="Driver" 
              class="w-14 h-14 rounded-full object-cover border-2 border-gray-700"
              (error)="$any($event.target).src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23666%22><circle cx=%2212%22 cy=%227%22 r=%224%22/><path d=%22M12 14c-5 0-8 2.5-8 5v2h16v-2c0-2.5-3-5-8-5z%22/></svg>'"
            >
            <div *ngIf="!ride.driver?.id" class="w-14 h-14 rounded-full bg-gray-700 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div>
              <div class="font-semibold text-white">{{ getDriverName() }}</div>
              <div class="text-sm text-gray-400">{{ getVehicleInfo() }}</div>
              <div class="text-xs text-gray-500 mt-1">{{ ride.driver?.email || '' }}</div>
            </div>
          </div>
        </div>

        <!-- Passengers Card -->
        <div class="bg-[#1C1C1E] rounded-2xl border border-gray-800 p-5">
          <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Passengers ({{ getPassengerCount() }})
          </h2>
          
          <div class="space-y-3">
            <div *ngFor="let p of getPassengers()" class="flex items-center gap-3 bg-black/40 rounded-lg p-3 border border-gray-800">
              <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              </div>
              <div>
                <div class="font-medium text-white text-sm">{{ p.name }}</div>
                <div class="text-xs text-gray-400">{{ p.email }}</div>
              </div>
            </div>
            <div *ngIf="getPassengerCount() === 0" class="text-gray-500 text-sm text-center py-2">
              No passengers
            </div>
          </div>
        </div>

        <!-- Route Card -->
        <div class="bg-[#1C1C1E] rounded-2xl border border-gray-800 p-5">
          <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
            Route
          </h2>
          
          <div class="space-y-4 relative pl-1">
            <div class="absolute left-[13px] top-3 bottom-3 w-0.5 bg-gray-800 border-l border-dashed border-gray-600"></div>

            <!-- Pickup -->
            <div class="flex gap-3 relative">
              <div class="mt-1 w-3 h-3 rounded-full bg-green-500 shrink-0 z-10"></div>
              <div>
                <div class="text-xs text-gray-400">Pickup</div>
                <div class="text-sm text-gray-200">{{ getPickupAddress() }}</div>
              </div>
            </div>

            <!-- Stops -->
            <ng-container *ngFor="let stop of getStops(); let i = index">
              <div class="flex gap-3 relative">
                <div class="mt-1 w-3 h-3 rounded-full shrink-0 z-10"
                     [ngClass]="completedStopIndexes.has(i) ? 'bg-green-500' : 'bg-gray-500'"></div>
                <div>
                  <div class="text-xs" [ngClass]="completedStopIndexes.has(i) ? 'text-green-500' : 'text-gray-400'">
                    Stop {{ i + 1 }} {{ completedStopIndexes.has(i) ? '‚úì' : '' }}
                  </div>
                  <div class="text-sm text-gray-200">{{ stop.address }}</div>
                </div>
              </div>
            </ng-container>

            <!-- Destination -->
            <div class="flex gap-3 relative">
              <div class="mt-1 w-3 h-3 rounded-full bg-red-500 shrink-0 z-10"></div>
              <div>
                <div class="text-xs text-gray-400">Destination</div>
                <div class="text-sm text-gray-200">{{ getDestinationAddress() }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panic Modal -->
  <div *ngIf="showPanicModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4">
    <div class="bg-[#1C1C1E] rounded-2xl border border-red-500/50 p-6 max-w-md w-full">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center">
          <span class="text-2xl">üö®</span>
        </div>
        <div>
          <h3 class="text-xl font-bold text-red-400">Panic Alert</h3>
          <p class="text-sm text-gray-400">Emergency signal activated</p>
        </div>
      </div>
      
      <div class="space-y-4 mb-6">
        <div class="bg-black/40 rounded-lg p-4 border border-gray-800">
          <div class="text-xs text-gray-400 mb-1">Message</div>
          <div class="text-white">{{ ride?.panicReason || 'No reason provided' }}</div>
        </div>
        <div class="bg-black/40 rounded-lg p-4 border border-gray-800">
          <div class="text-xs text-gray-400 mb-1">Time Pressed</div>
          <div class="text-white">{{ formatPanicTime() }}</div>
        </div>
      </div>

      <button 
        (click)="closePanicModal()"
        class="w-full py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl font-semibold transition-colors"
      >
        Close
      </button>
    </div>
  </div>
</div>
